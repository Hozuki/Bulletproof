{"version":3,"sources":["danmaku/code/codedanmaku.ts"],"names":["CodeDanmaku","CodeDanmaku.constructor","CodeDanmaku.danmakuKind","CodeDanmaku.layoutManager","CodeDanmaku.danmakuProvider","CodeDanmaku.getContent","CodeDanmaku.getText","CodeDanmaku.initialize","CodeDanmaku.bulletproof","CodeDanmaku.bornTime","CodeDanmaku.lifeTime","CodeDanmaku.___censor","CodeDanmaku.___update","CodeDanmaku.___render","CodeDanmaku.___buildFunction","CodeDanmaku.___applyFunction","CodeDanmaku.___applyMotionGroups","CodeDanmaku.___applyMotionGroup","CodeDanmaku.___applyMotion","CodeDanmaku.___removeDeadDCObjects"],"mappings":"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","file":"danmaku/code/CodeDanmaku.js","sourcesContent":["/**\r\n * Created by MIC on 2015/12/28.\r\n */\r\n\r\nimport {DanmakuKind} from \"../DanmakuKind\";\r\nimport {CodeDanmakuLayoutManager} from \"./CodeDanmakuLayoutManager\";\r\nimport {WebGLRenderer} from \"../../../lib/glantern/src/webgl/WebGLRenderer\";\r\nimport {NotImplementedError} from \"../../../lib/glantern/src/_util/NotImplementedError\";\r\nimport {Stage} from \"../../../lib/glantern/src/flash/display/Stage\";\r\nimport {DisplayObjectContainer} from \"../../../lib/glantern/src/flash/display/DisplayObjectContainer\";\r\nimport {Bulletproof} from \"../../Bulletproof\";\r\nimport {DisplayObject} from \"../../../lib/glantern/src/flash/display/DisplayObject\";\r\nimport {IDanmakuCreatedObject} from \"./dco/IDanmakuCreatedObject\";\r\nimport {BiliBiliDanmakuApiContainer} from \"../../bilibili/BiliBiliDanmakuApiContainer\";\r\nimport {IMotion} from \"../../bilibili/danmaku_api/data_types/IMotion\";\r\nimport {IMotionPropertyAnimation} from \"../../bilibili/danmaku_api/data_types/IMotionPropertyAnimation\";\r\nimport {_util} from \"../../../lib/glantern/src/_util/_util\";\r\nimport {CodeDanmakuProvider} from \"./CodeDanmakuProvider\";\r\nimport {IDanmaku} from \"../IDanmaku\";\r\nimport {Point} from \"../../../lib/glantern/src/flash/geom/Point\";\r\nimport {BulletproofConfig} from \"../../BulletproofConfig\";\r\n\r\nexport class CodeDanmaku extends DisplayObjectContainer implements IDanmaku {\r\n\r\n    constructor(root:Stage, parent:DisplayObjectContainer, layoutManager:CodeDanmakuLayoutManager) {\r\n        super(root, parent);\r\n        this._layoutManager = layoutManager;\r\n        this._danmakuProvider = layoutManager.danmakuProvider;\r\n        this._bulletproof = layoutManager.bulletproof;\r\n    }\r\n\r\n    get danmakuKind():DanmakuKind {\r\n        return DanmakuKind.Code;\r\n    }\r\n\r\n    get layoutManager():CodeDanmakuLayoutManager {\r\n        return this._layoutManager;\r\n    }\r\n\r\n    get danmakuProvider():CodeDanmakuProvider {\r\n        return this._danmakuProvider;\r\n    }\r\n\r\n    getContent():string {\r\n        return this._content;\r\n    }\r\n\r\n    getText():string {\r\n        // No readable text.\r\n        return \"\";\r\n    }\r\n\r\n    initialize(content:string, time:number):void {\r\n        this._content = content;\r\n        this._bornTime = time;\r\n        this._apiContainer = new BiliBiliDanmakuApiContainer(this);\r\n        if (this.__censor()) {\r\n            this._lambda = this.__buildFunction();\r\n            this.__applyFunction();\r\n        }\r\n    }\r\n\r\n    get bulletproof():Bulletproof {\r\n        return this._bulletproof;\r\n    }\r\n\r\n    get bornTime():number {\r\n        return this._bornTime;\r\n    }\r\n\r\n    get lifeTime():number {\r\n        return BulletproofConfig.codeDanmakuLifeTimeSecs;\r\n    }\r\n\r\n    private __censor():boolean {\r\n        return true;\r\n    }\r\n\r\n    protected __update():void {\r\n        this.__removeDeadDCObjects();\r\n        this.__applyMotionGroups();\r\n    }\r\n\r\n    protected __render(renderer:WebGLRenderer):void {\r\n        // Do nothing, let children render themselves.\r\n    }\r\n\r\n    private __buildFunction():Function {\r\n        // Weak defense is better than none.\r\n        // TODO: Use WebWorker to create a safety sandbox.\r\n        var api = this._apiContainer.api;\r\n        this._apiNames = [];\r\n        for (var apiName in api) {\r\n            this._apiNames.push(apiName);\r\n        }\r\n        var funcArgs = this._apiNames.concat(this._content);\r\n        return Function.prototype.constructor.apply(Object.create(null), funcArgs);\r\n    }\r\n\r\n    private __applyFunction():void {\r\n        var ac = this._apiContainer;\r\n        var apiValues:any[] = [];\r\n        for (var i = 0; i < this._apiNames.length; ++i) {\r\n            apiValues.push((<any>ac.api)[this._apiNames[i]]);\r\n        }\r\n        this._lambda.apply(null, apiValues);\r\n    }\r\n\r\n    protected __applyMotionGroups():void {\r\n        var child:DisplayObject&IDanmakuCreatedObject;\r\n        var time = this.bulletproof.timeElapsed;\r\n        for (var i = 0; i < this._children.length; ++i) {\r\n            child = <DisplayObject&IDanmakuCreatedObject><any>this._children[i];\r\n            if (child.isCreatedByDanmaku) {\r\n                if (!_util.isUndefinedOrNull(child.createParams.motion)) {\r\n                    CodeDanmaku.__applyMotion(child.createParams.motion, time);\r\n                } else if (!_util.isUndefinedOrNull(child.createParams.motionGroup)) {\r\n                    CodeDanmaku.__applyMotionGroup(child.createParams.motionGroup, time);\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    protected static __applyMotionGroup(motionGroup:IMotion[], now:number):void {\r\n        var motion:IMotion;\r\n        if (!_util.isUndefinedOrNull(motionGroup)) {\r\n            //console.log(\"Calculating: \", obj, \" on \", now);\r\n            for (var i = 0; i < motionGroup.length; ++i) {\r\n                motion = motionGroup[i];\r\n                CodeDanmaku.__applyMotion(motion, now);\r\n            }\r\n        }\r\n    }\r\n\r\n    protected static __applyMotion(motion:IMotion, now:number):void {\r\n        var propertyNames:string[] = [\"x\", \"y\", \"alpha\", \"rotationZ\", \"rotationY\"];\r\n        var motionAnimation:IMotionPropertyAnimation;\r\n        var relativeTime:number;\r\n        var value:number;\r\n        if (motion.createdTime <= now && now <= motion.createdTime + motion.maximumLifeTime) {\r\n            for (var j = 0; j < propertyNames.length; ++j) {\r\n                motionAnimation = <IMotionPropertyAnimation>(<any>motion)[propertyNames[j]];\r\n                if (!_util.isUndefinedOrNull(motionAnimation)) {\r\n                    relativeTime = now - motion.createdTime;\r\n                    if (!_util.isUndefinedOrNull(motionAnimation.startDelay)) {\r\n                        relativeTime -= motionAnimation.startDelay;\r\n                    }\r\n                    if (relativeTime <= motionAnimation.lifeTime * 1000) {\r\n                        // TODO: property 'repeat' is ignored here.\r\n                        // TODO: easing usage is always interpreted as linear here.\r\n                        value = motionAnimation.fromValue +\r\n                            (motionAnimation.toValue - motionAnimation.fromValue) / (motionAnimation.lifeTime * 1000) * relativeTime;\r\n                        (<any>motion.sourceObject)[propertyNames[j]] = value;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    protected __removeDeadDCObjects():void {\r\n        var bulletproof = this._bulletproof;\r\n        var child:DisplayObject&IDanmakuCreatedObject;\r\n        for (var i = 0; i < this._children.length; ++i) {\r\n            child = <DisplayObject&IDanmakuCreatedObject><any>this._children[i];\r\n            if (child.isCreatedByDanmaku) {\r\n                if (child.extraCreateParams.bornTime + child.createParams.lifeTime * 1000 < bulletproof.timeElapsed) {\r\n                    this.removeChild(child);\r\n                    child.dispose();\r\n                    --i;\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    private _apiNames:string[] = null;\r\n    private _apiContainer:BiliBiliDanmakuApiContainer = null;\r\n    private _lambda:Function = null;\r\n    private _content:string = null;\r\n    private _bornTime:number = 0;\r\n    private _bulletproof:Bulletproof = null;\r\n    private _layoutManager:CodeDanmakuLayoutManager;\r\n    private _danmakuProvider:CodeDanmakuProvider;\r\n\r\n}\r\n"],"sourceRoot":"/source/"}
{"version":3,"sources":["danmaku/danmakucoordinator.ts"],"names":["DanmakuCoordinator","DanmakuCoordinator.constructor","DanmakuCoordinator.dispose","DanmakuCoordinator.shouldCreateDanmaku","DanmakuCoordinator.addDanmakuProvider","DanmakuCoordinator.removeDanmakuProvider","DanmakuCoordinator.getDanmakuProvider","DanmakuCoordinator.update","DanmakuCoordinator.render","DanmakuCoordinator.bulletproof"],"mappings":"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","file":"danmaku/DanmakuCoordinator.js","sourcesContent":["/**\r\n * Created by MIC on 2015/12/29.\r\n */\r\n\r\nimport {IDisposable} from \"../../lib/glantern/src/IDisposable\";\r\nimport {NotImplementedError} from \"../../lib/glantern/src/_util/NotImplementedError\";\r\nimport {_util} from \"../../lib/glantern/src/_util/_util\";\r\nimport {DanmakuKind} from \"./DanmakuKind\";\r\nimport {DanmakuProviderBase} from \"./DanmakuProviderBase\";\r\nimport {Bulletproof} from \"../Bulletproof\";\r\nimport {IWebGLElement} from \"../../lib/glantern/src/webgl/IWebGLElement\";\r\nimport {WebGLRenderer} from \"../../lib/glantern/src/webgl/WebGLRenderer\";\r\nimport {DanmakuProviderFlag} from \"./DanmakuProviderFlag\";\r\nimport {BulletproofConfig} from \"../BulletproofConfig\";\r\n\r\n/**\r\n * The coordinator of all danmakus.\r\n * This class is a factory and manager of danmaku providers.\r\n */\r\nexport class DanmakuCoordinator implements IWebGLElement {\r\n\r\n    /**\r\n     * Creates a new {@Link DanmakuCoordinator} instance.\r\n     * @param bulletproof {Bulletproof} The {@link Bulletproof} instance that will be attached to.\r\n     */\r\n    constructor(bulletproof:Bulletproof) {\r\n        this._bulletproof = bulletproof;\r\n        this._danmakuProviders = new Map<DanmakuKind, DanmakuProviderBase>();\r\n    }\r\n\r\n    /**\r\n     * Disposes the {@link DanmakuCoordinator} instance and release all resources occupied.\r\n     */\r\n    dispose():void {\r\n        this._danmakuProviders.forEach((provider:DanmakuProviderBase):void => {\r\n            provider.dispose();\r\n        });\r\n        this._danmakuProviders.clear();\r\n        this._danmakuProviders = null;\r\n    }\r\n\r\n    /**\r\n     * Determines whether a danmaku should be created, in a global view.\r\n     * For example, if the density of danmakus are too high, this function should returns false when a\r\n     * {@link SimpleDanmakuProvider} is requesting creation of a new danmaku, to avoid performance drop.\r\n     * Danmaku providers should check via this function before actually creating a danmaku.\r\n     * @param requestingProvider {DanmakuProviderBase} The danmaku provider requesting the check.\r\n     */\r\n    shouldCreateDanmaku(requestingProvider:DanmakuProviderBase):boolean {\r\n        var canCreate = true;\r\n        var totalDanmakuCount = 0;\r\n        var globalThreshold = BulletproofConfig.globalDanmakuCountThreshold;\r\n        this._danmakuProviders.forEach((provider:DanmakuProviderBase):void => {\r\n            // If a danmaku provider has no number limit, it contributes 0 to the total count.\r\n            if (!canCreate || (requestingProvider.flags & DanmakuProviderFlag.UnlimitedCreation) !== 0) {\r\n                return;\r\n            }\r\n            totalDanmakuCount += provider.displayingDanmakuList.length;\r\n            if (totalDanmakuCount > globalThreshold) {\r\n                canCreate = false;\r\n            }\r\n        });\r\n        return canCreate;\r\n    }\r\n\r\n    /**\r\n     * Adds a new kind of danmaku provider to provider instance list. If the a provider of that kind\r\n     * already exists, the new one will not be added.\r\n     * @param provider {DanmakuProviderBase} The danmaku provider preparing to be added.\r\n     */\r\n    addDanmakuProvider(provider:DanmakuProviderBase):void {\r\n        if (!_util.isUndefinedOrNull(provider) && !this._danmakuProviders.has(provider.danmakuKind)) {\r\n            this._danmakuProviders.set(provider.danmakuKind, provider);\r\n            provider.initialize();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Removes a new kind of danmaku provider from provider instance list.\r\n     * @param provider {DanmakuProviderBase} The danmaku provider preparing to be removed.\r\n     */\r\n    removeDanmakuProvider(provider:DanmakuProviderBase):void {\r\n        if (!_util.isUndefinedOrNull(provider) && this._danmakuProviders.has(provider.danmakuKind)) {\r\n            this._danmakuProviders.delete(provider.danmakuKind);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Gets the instance of danmaku provider whose kind is as specified. If the kind is not registered,\r\n     * a null value will be returned.\r\n     * @param kind {DanmakuKind} The danmaku kind of requested danmaku provider.\r\n     * @returns {DanmakuProviderBase}\r\n     */\r\n    getDanmakuProvider(kind:DanmakuKind):DanmakuProviderBase {\r\n        var provider = this._danmakuProviders.get(kind);\r\n        if (_util.isUndefinedOrNull(provider)) {\r\n            return null;\r\n        } else {\r\n            return provider;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Updates the status of all danmaku providers.\r\n     */\r\n    update():void {\r\n        this._danmakuProviders.forEach((provider:DanmakuProviderBase):void => {\r\n            provider.update();\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Perform extra rendering if needed.\r\n     * @param renderer {WebGLRenderer} The renderer used.\r\n     */\r\n    render(renderer:WebGLRenderer):void {\r\n        // Do nothing.\r\n    }\r\n\r\n    /**\r\n     * Gets the {@link Bulletproof} instance that controls this {@link DanmakuCoordinator}.\r\n     * @returns {Bulletproof}\r\n     */\r\n    get bulletproof():Bulletproof {\r\n        return this._bulletproof;\r\n    }\r\n\r\n    private _danmakuProviders:Map<DanmakuKind, DanmakuProviderBase> = null;\r\n    private _bulletproof:Bulletproof = null;\r\n\r\n}\r\n"],"sourceRoot":"/source/"}
{"version":3,"sources":["danmaku/scripted/scripteddanmakuprovider.ts"],"names":["ScriptedDanmakuProvider","ScriptedDanmakuProvider.constructor","ScriptedDanmakuProvider.danmakuKind","ScriptedDanmakuProvider.addDanmaku","ScriptedDanmakuProvider.dispose","ScriptedDanmakuProvider.initialize","ScriptedDanmakuProvider.canCreateDanmaku","ScriptedDanmakuProvider.removeDanmaku","ScriptedDanmakuProvider.isDanmakuDead","ScriptedDanmakuProvider.update","ScriptedDanmakuProvider.updateDisplayDanmakuList","ScriptedDanmakuProvider.layoutManager","ScriptedDanmakuProvider.displayingDanmakuList","ScriptedDanmakuProvider.fullDanmakuList","ScriptedDanmakuProvider.danmakuLayer","ScriptedDanmakuProvider.flags","ScriptedDanmakuProvider.___addDanmaku"],"mappings":"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","file":"danmaku/scripted/ScriptedDanmakuProvider.js","sourcesContent":["/**\r\n * Created by MIC on 2015/12/28.\r\n */\r\n\r\nimport {DanmakuProviderBase} from \"../DanmakuProviderBase\";\r\nimport {DanmakuKind} from \"../DanmakuKind\";\r\nimport {DanmakuLayoutManagerBase} from \"../DanmakuLayoutManagerBase\";\r\nimport {ScriptedDanmakuLayoutManager} from \"./ScriptedDanmakuLayoutManager\";\r\nimport {DanmakuCoordinator} from \"../DanmakuCoordinator\";\r\nimport {ScriptedDanmaku} from \"./ScriptedDanmaku\";\r\nimport {DanmakuProviderFlag} from \"../DanmakuProviderFlag\";\r\nimport {ScriptedDanmakuLayer} from \"./ScriptedDanmakuLayer\";\r\nimport {IScriptedDanmakuCreateParams} from \"./IScriptedDanmakuCreateParams\";\r\nimport {ScriptedDanmakuHelper} from \"./ScriptedDanmakuHelper\";\r\nimport {IDanmaku} from \"../IDanmaku\";\r\nimport {GLUtil} from \"../../../lib/glantern/lib/glantern-utils/src/GLUtil\";\r\n\r\n/**\r\n * An implementation of {@link DanmakuProviderBase}, for managing code damakus.\r\n */\r\nexport class ScriptedDanmakuProvider extends DanmakuProviderBase {\r\n\r\n    constructor(coordinator:DanmakuCoordinator) {\r\n        super(coordinator);\r\n        this._layoutManager = new ScriptedDanmakuLayoutManager(this);\r\n    }\r\n\r\n    get danmakuKind():DanmakuKind {\r\n        return DanmakuKind.Scripted;\r\n    }\r\n\r\n    addDanmaku(content:string, args?:IScriptedDanmakuCreateParams):IDanmaku {\r\n        return super.addDanmaku(content, args);\r\n    }\r\n\r\n    dispose():void {\r\n        this._danmakuLayer.parent.removeChild(this._danmakuLayer);\r\n        this._danmakuLayer.dispose();\r\n        this._layoutManager.dispose();\r\n        this._layoutManager = null;\r\n        for (var i = 0; i < this.displayingDanmakuList.length; ++i) {\r\n            this.displayingDanmakuList[i].dispose();\r\n        }\r\n        while (this.displayingDanmakuList.length > 0) {\r\n            this.displayingDanmakuList.pop();\r\n        }\r\n        this._danmakuLayer = null;\r\n        this._displayingDanmakuList = null;\r\n    }\r\n\r\n    initialize():void {\r\n        var stage = this.bulletproof.stage;\r\n        this._danmakuLayer = new ScriptedDanmakuLayer(stage, stage);\r\n        stage.addChild(this._danmakuLayer);\r\n    }\r\n\r\n    canCreateDanmaku(args?:any):boolean {\r\n        return true;\r\n    }\r\n\r\n    removeDanmaku(danmaku:ScriptedDanmaku):boolean {\r\n        var index = this.displayingDanmakuList.indexOf(danmaku);\r\n        if (index < 0) {\r\n            return false;\r\n        } else {\r\n            this.bulletproof.stage.removeChild(danmaku);\r\n            this.displayingDanmakuList.splice(index, 1);\r\n            danmaku.dispose();\r\n            return true;\r\n        }\r\n    }\r\n\r\n    isDanmakuDead(danmaku:ScriptedDanmaku):boolean {\r\n        var timeElapsed = this.bulletproof.timeElapsed;\r\n        if (timeElapsed < danmaku.bornTime) {\r\n            return danmaku.executed;\r\n        } else {\r\n            return danmaku.bornTime + danmaku.lifeTime * 1000 < timeElapsed;\r\n        }\r\n    }\r\n\r\n    update():void {\r\n        super.update();\r\n        var danmaku:ScriptedDanmaku;\r\n        var timeElapsed = this.bulletproof.timeElapsed;\r\n        for (var i = 0; i < this.displayingDanmakuList.length; ++i) {\r\n            danmaku = this.displayingDanmakuList[i];\r\n            if (!danmaku.executed && timeElapsed >= danmaku.bornTime) {\r\n                danmaku.execute();\r\n            }\r\n        }\r\n    }\r\n\r\n    updateDisplayDanmakuList():void {\r\n        var danmaku:ScriptedDanmaku;\r\n        for (var i = 0; i < this.displayingDanmakuList.length; ++i) {\r\n            danmaku = this.displayingDanmakuList[i];\r\n            if (this.isDanmakuDead(danmaku)) {\r\n                this.removeDanmaku(danmaku);\r\n                --i;\r\n            }\r\n        }\r\n    }\r\n\r\n    get layoutManager():ScriptedDanmakuLayoutManager {\r\n        return this._layoutManager;\r\n    }\r\n\r\n    get displayingDanmakuList():ScriptedDanmaku[] {\r\n        return this._displayingDanmakuList;\r\n    }\r\n\r\n    get fullDanmakuList():ScriptedDanmaku[] {\r\n        return this._displayingDanmakuList;\r\n    }\r\n\r\n    get danmakuLayer():ScriptedDanmakuLayer {\r\n        return this._danmakuLayer;\r\n    }\r\n\r\n    get flags():DanmakuProviderFlag {\r\n        return DanmakuProviderFlag.UnlimitedCreation;\r\n    }\r\n\r\n    protected __addDanmaku(content:string, args?:IScriptedDanmakuCreateParams):ScriptedDanmaku {\r\n        if (GLUtil.isUndefinedOrNull(args)) {\r\n            args = ScriptedDanmakuHelper.getDefaultParams(this.bulletproof.config);\r\n        }\r\n        var danmaku = new ScriptedDanmaku(this.bulletproof.stage, this.danmakuLayer, this.layoutManager, args);\r\n        // Add to the last position of all currently active damakus to ensure being drawn as topmost.\r\n        this.danmakuLayer.addChild(danmaku);\r\n        danmaku.initialize(content, this.bulletproof.timeElapsed);\r\n        this.displayingDanmakuList.push(danmaku);\r\n        return danmaku;\r\n    }\r\n\r\n    protected _displayingDanmakuList:ScriptedDanmaku[];\r\n    protected _layoutManager:ScriptedDanmakuLayoutManager;\r\n    protected _danmakuLayer:ScriptedDanmakuLayer;\r\n\r\n}\r\n"],"sourceRoot":"/source/"}
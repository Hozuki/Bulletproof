{"version":3,"sources":["danmaku/simple/simpledanmakulayer.ts"],"names":["SimpleDanmakuLayer","SimpleDanmakuLayer.constructor","SimpleDanmakuLayer.danmakuProvider","SimpleDanmakuLayer.context2D","SimpleDanmakuLayer.___update","SimpleDanmakuLayer.___render","SimpleDanmakuLayer.___drawTextElements","SimpleDanmakuLayer.___drawSimpleDanmaku"],"mappings":"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","file":"danmaku/simple/SimpleDanmakuLayer.js","sourcesContent":["/**\r\n * Created by MIC on 2016/2/2.\r\n */\r\n\r\nimport {SimpleDanmakuProvider} from \"./SimpleDanmakuProvider\";\r\nimport {SimpleDanmaku} from \"./SimpleDanmaku\";\r\nimport {TextField} from \"../../../lib/glantern/src/glantern/flash/text/TextField\";\r\nimport {Stage} from \"../../../lib/glantern/src/glantern/flash/display/Stage\";\r\nimport {DisplayObjectContainer} from \"../../../lib/glantern/src/glantern/flash/display/DisplayObjectContainer\";\r\nimport {WebGLRenderer} from \"../../../lib/glantern/src/glantern/webgl/WebGLRenderer\";\r\nimport {RenderHelper} from \"../../../lib/glantern/src/glantern/webgl/RenderHelper\";\r\nimport {GLUtil} from \"../../../lib/glantern/lib/glantern-utils/src/GLUtil\";\r\n\r\nexport class SimpleDanmakuLayer extends TextField {\r\n\r\n    constructor(root:Stage, parent:DisplayObjectContainer, provider:SimpleDanmakuProvider) {\r\n        super(root, parent);\r\n        this._provider = provider;\r\n    }\r\n\r\n    get danmakuProvider():SimpleDanmakuProvider {\r\n        return this._provider;\r\n    }\r\n\r\n    get context2D():CanvasRenderingContext2D {\r\n        return this._context2D;\r\n    }\r\n\r\n    protected __update():void {\r\n        if (this.danmakuProvider.displayingDanmakuList.length > 0) {\r\n            this._canvasTarget.updateImageSize();\r\n            this.__drawTextElements(this.context2D);\r\n        }\r\n    }\r\n\r\n    protected __render(renderer:WebGLRenderer):void {\r\n        if (this.visible && this.alpha > 0 && this.danmakuProvider.displayingDanmakuList.length > 0) {\r\n            this._canvasTarget.updateImageContent();\r\n            RenderHelper.copyImageContent(renderer, this._canvasTarget, renderer.currentRenderTarget, false, true, this.transform.matrix3D, this.alpha, false);\r\n        }\r\n    }\r\n\r\n    protected __drawTextElements(context2D:CanvasRenderingContext2D):void {\r\n        var danmaku:SimpleDanmaku;\r\n        var lastDanmaku:SimpleDanmaku = null;\r\n        var danmakuList = this.danmakuProvider.displayingDanmakuList;\r\n        context2D.clearRect(0, 0, context2D.canvas.width, context2D.canvas.height);\r\n        for (var i = 0; i < danmakuList.length; ++i) {\r\n            danmaku = danmakuList[i];\r\n            this.__drawSimpleDanmaku(context2D, danmaku, lastDanmaku);\r\n            lastDanmaku = danmaku;\r\n        }\r\n    }\r\n\r\n    protected __drawSimpleDanmaku(context2D:CanvasRenderingContext2D, danmaku:SimpleDanmaku, last:SimpleDanmaku):void {\r\n        if (!danmaku.visible) {\r\n            return;\r\n        }\r\n        var x = danmaku.x, y = danmaku.y;\r\n        var cp = danmaku.createParams;\r\n        var baseX = cp.outline && cp.outlineThickness > 0 ? cp.outlineThickness : 0;\r\n        var baseY = baseX;\r\n        var borderThickness = cp.border && cp.borderThickness > 0 ? cp.borderThickness : 0;\r\n        if (GLUtil.isUndefinedOrNull(last) || cp.fontName !== last.createParams.fontName || cp.fontSize !== last.createParams.fontSize) {\r\n            context2D.font = cp.fontStyle.toString() + \" \" + cp.fontSize.toString() + \"pt \\\"\" + cp.fontName + \"\\\"\";\r\n        }\r\n        var textWidth = danmaku.textWidth;\r\n        // See TextField.ts.\r\n        var textHeight = danmaku.textHeight;\r\n        if (cp.background) {\r\n            context2D.fillStyle = GLUtil.colorToCssSharp(cp.backgroundColor);\r\n            context2D.fillRect(x, y, textWidth + borderThickness * 2, textHeight + borderThickness * 2);\r\n        }\r\n        context2D.fillStyle = GLUtil.colorToCssSharp(cp.textColor);\r\n        context2D.fillText(danmaku.getText(), x + baseX + borderThickness, y + textHeight * 0.75 + borderThickness);\r\n        if (cp.outline && cp.outlineThickness > 0) {\r\n            context2D.lineWidth = cp.outlineThickness;\r\n            context2D.strokeStyle = GLUtil.colorToCssSharp(cp.outlineColor);\r\n            context2D.strokeText(danmaku.getText(), x + baseX + borderThickness, y + textHeight * 0.75 + borderThickness);\r\n        }\r\n        if (cp.border && cp.borderThickness > 0) {\r\n            context2D.lineWidth = cp.borderThickness;\r\n            context2D.strokeStyle = GLUtil.colorToCssSharp(cp.borderColor);\r\n            context2D.strokeRect(x + borderThickness, y + borderThickness, textWidth + borderThickness * 2, this.textHeight + borderThickness * 2);\r\n        }\r\n    }\r\n\r\n    private _provider:SimpleDanmakuProvider = null;\r\n\r\n}\r\n"],"sourceRoot":"/source/"}
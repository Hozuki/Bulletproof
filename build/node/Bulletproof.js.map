{"version":3,"sources":["bulletproof.ts"],"names":["Bulletproof","Bulletproof.constructor","Bulletproof.initialize","Bulletproof.startAnimation","Bulletproof.stopAnimation","Bulletproof.dispose","Bulletproof.danmakuCoordinator","Bulletproof.isAnimationRunning","Bulletproof.timeElapsed","Bulletproof.fps","Bulletproof.videoPlayer","Bulletproof.videoView","Bulletproof.config","Bulletproof.blackCurtainView","Bulletproof.___updateComponents"],"mappings":"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","file":"Bulletproof.js","sourcesContent":["/**\r\n * Created by MIC on 2015/12/28.\r\n */\r\n\r\nimport {GLantern} from \"../lib/glantern/src/GLantern\";\r\nimport {DanmakuCoordinator} from \"./danmaku/DanmakuCoordinator\";\r\nimport {ScriptedDanmakuProvider} from \"./danmaku/scripted/ScriptedDanmakuProvider\";\r\nimport {DanmakuProviderBase} from \"./danmaku/DanmakuProviderBase\";\r\nimport {NotImplementedError} from \"../lib/glantern/src/_util/NotImplementedError\";\r\nimport {SimpleDanmakuProvider} from \"./danmaku/simple/SimpleDanmakuProvider\";\r\nimport {BulletproofConfig} from \"./BulletproofConfig\";\r\nimport {VideoPlayerBase} from \"./interactive/video/VideoPlayerBase\";\r\nimport {_util} from \"../lib/glantern/src/_util/_util\";\r\nimport {Html5VideoPlayer} from \"./interactive/video/html5/Html5VideoPlayer\";\r\nimport {IBulletproofConfig} from \"./IBulletproofConfig\";\r\n\r\n/**\r\n * The root controller for Bulletproof.\r\n */\r\nexport class Bulletproof extends GLantern {\r\n\r\n    /**\r\n     * Creates a new {@link Bulletproof} instance.\r\n     */\r\n    constructor() {\r\n        super();\r\n        this._config = _util.deepClone(BulletproofConfig);\r\n    }\r\n\r\n    /**\r\n     * Initialize the {@link Bulletproof} instance with default parameters.\r\n     * @param width {Number} Width of stage requested, in pixels.\r\n     * @param height {Number} Height of stage requested, in pixels.\r\n     */\r\n    initialize(width:number, height:number):void {\r\n        if (!this._isInitialized) {\r\n            super.initialize(width, height);\r\n\r\n            var config = this.config;\r\n\r\n            this.attachUpdateFunction(this.__updateComponents.bind(this));\r\n            var coordinator = new DanmakuCoordinator(this);\r\n            this._coordinator = coordinator;\r\n\r\n            // The earlier a provider is added in, the deeper it is in Z axis.\r\n            var provider:DanmakuProviderBase;\r\n            if (config.codeDanmakuEnabled) {\r\n                provider = new ScriptedDanmakuProvider(coordinator);\r\n                coordinator.addDanmakuProvider(provider);\r\n            }\r\n            if (config.simpleDanmakuEnabled) {\r\n                provider = new SimpleDanmakuProvider(coordinator);\r\n                coordinator.addDanmakuProvider(provider);\r\n            }\r\n\r\n            if (config.videoPlayerEnabled) {\r\n                if (config.useWebChimeraForVideoPlayback) {\r\n                } else {\r\n                    this._videoPlayer = new Html5VideoPlayer();\r\n                }\r\n                if (this._videoPlayer !== null) {\r\n                    this._videoPlayer.initialize(width, height);\r\n                }\r\n            }\r\n\r\n            var blackCurtainView = window.document.createElement(\"div\");\r\n            var blackCurtainStyle = blackCurtainView.style;\r\n            blackCurtainStyle.width = `${width}px`;\r\n            blackCurtainStyle.height = `${height}px`;\r\n            blackCurtainStyle.backgroundColor = \"black\";\r\n            this._blackCurtainView = blackCurtainView;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Starts the animation loop. Updating and rendering are automatically handled in the loop.\r\n     * By default, {@link startAnimation} uses {@link window.requestAnimationFrame} function and relies\r\n     * on the frame rate adjuster of the browser window.\r\n     */\r\n    startAnimation():void {\r\n        if (!this.isAnimationRunning) {\r\n            this._lastUpdatedTime = Date.now();\r\n        }\r\n        super.startAnimation();\r\n    }\r\n\r\n    /**\r\n     * Stops the animation loop. Internal state is preserved, and the next {@link startAnimation} call resumes\r\n     * from last state.\r\n     */\r\n    stopAnimation():void {\r\n        this.__updateComponents();\r\n        super.stopAnimation();\r\n    }\r\n\r\n    /**\r\n     * Disposes the {@link Bulletproof} instance and release all resources occupied.\r\n     */\r\n    dispose():void {\r\n        this._coordinator.dispose();\r\n        this._coordinator = null;\r\n        super.dispose();\r\n    }\r\n\r\n    /**\r\n     * Gets the {@link DanmakuCoordinator} instance associated with current {@link Bulletproof} instance.\r\n     * @returns {DanmakuCoordinator}\r\n     */\r\n    get danmakuCoordinator():DanmakuCoordinator {\r\n        return this._coordinator;\r\n    }\r\n\r\n    /**\r\n     * Gets a boolean flag indicating whether the animation loop is running.\r\n     * @returns {Boolean}\r\n     */\r\n    get isAnimationRunning():boolean {\r\n        return this._isRunning;\r\n    }\r\n\r\n    /**\r\n     * Gets total time elapsed in handling the animation loop, in milliseconds.\r\n     * @returns {Number}\r\n     */\r\n    get timeElapsed():number {\r\n        return this._totalElapsedTime;\r\n    }\r\n\r\n    /**\r\n     * Gets the average FPS (frame per second) of last second.\r\n     * @returns {Number}\r\n     */\r\n    get fps():number {\r\n        return this._fps;\r\n    }\r\n\r\n    get videoPlayer():VideoPlayerBase {\r\n        return this._videoPlayer;\r\n    }\r\n\r\n    get videoView():HTMLElement {\r\n        if (_util.isUndefinedOrNull(this._videoPlayer)) {\r\n            return null;\r\n        } else {\r\n            return this._videoPlayer.view;\r\n        }\r\n    }\r\n\r\n    get config():IBulletproofConfig {\r\n        return this._config;\r\n    }\r\n\r\n    get blackCurtainView():HTMLDivElement {\r\n        return this._blackCurtainView;\r\n    }\r\n\r\n    protected __updateComponents():void {\r\n        if (this._lastUpdatedTime > 0) {\r\n            var now = Date.now();\r\n            this._totalElapsedTime += now - this._lastUpdatedTime;\r\n            this._lastUpdatedTime = now;\r\n        }\r\n        ++this._fpsCounter;\r\n        if (this.timeElapsed - this._lastFpsUpdateElapsedTime > 1000) {\r\n            this._fps = this._fpsCounter / (this.timeElapsed - this._lastFpsUpdateElapsedTime) * 1000;\r\n            this._fpsCounter = 0;\r\n            this._lastFpsUpdateElapsedTime = this.timeElapsed;\r\n        }\r\n        this._coordinator.update();\r\n    }\r\n\r\n    protected _lastUpdatedTime:number = -1;\r\n    protected _totalElapsedTime:number = 0;\r\n    protected _fps:number = 0;\r\n    protected _fpsCounter:number = 0;\r\n    protected _lastFpsUpdateElapsedTime:number = 0;\r\n    protected _coordinator:DanmakuCoordinator = null;\r\n    protected _videoPlayer:VideoPlayerBase = null;\r\n    protected _config:IBulletproofConfig = null;\r\n    protected _blackCurtainView:HTMLDivElement = null;\r\n\r\n}\r\n"],"sourceRoot":"/source/"}